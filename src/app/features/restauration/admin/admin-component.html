<div class="min-h-screen bg-gradient-to-br from-[#FFFFFF] via-[#E1E1E1] to-[#99CFBD] p-4 md:p-6">
  <div class="max-w-[1800px] mx-auto">
    <!-- üéØ HEADER -->
    <div class="mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <div class="flex items-center gap-3">
          <div
            class="w-14 h-14 bg-gradient-to-br from-[#25509D] to-[#20264E] rounded-2xl flex items-center justify-center shadow-xl"
          >
            <fa-icon [icon]="['fas', 'crown']" class="text-white text-2xl"></fa-icon>
          </div>
          <div>
            <h1 class="text-3xl md:text-4xl font-black text-[#20264E]">Dashboard Admin</h1>
            <p class="text-[#303131] font-medium">
              {{ dashboardData() ? formatDate(dashboardData()!.date) : 'Chargement...' }}
            </p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <!-- üîí BOUTON DE VALIDATION - ACTIF UNIQUEMENT LE VENDREDI -->
          <button
            (click)="openPaymentModal()"
            [disabled]="!canValidatePayments()"
            [class]="
              canValidatePayments()
                ? 'px-4 py-2.5 cursor-pointer bg-gradient-to-r from-[#99CFBD] to-[#99CFBD]/80 text-white rounded-xl font-bold hover:shadow-xl transition-all flex items-center gap-2'
                : 'px-4 py-2.5 cursor-not-allowed bg-gray-400 text-gray-200 rounded-xl font-bold flex items-center gap-2 opacity-60'
            "
            [title]="
              canValidatePayments()
                ? 'Valider les paiements de la semaine'
                : paymentValidationState()?.message || 'Disponible uniquement le vendredi'
            "
          >
            <fa-icon
              [icon]="canValidatePayments() ? ['fas', 'money-bill-wave'] : ['fas', 'lock']"
            ></fa-icon>
            <span class="hidden md:inline">
              {{
                canValidatePayments()
                  ? 'Cl√¥turer commande de la semaine'
                  : 'Validation vendredi uniquement'
              }}
            </span>
            @if (!canValidatePayments() && paymentValidationState()?.nextFriday) {
            <span class="hidden lg:inline text-xs">
              ({{ formatDate(paymentValidationState()!.nextFriday!) }})
            </span>
            }
          </button>
          <input
            type="date"
            [value]="filters().selectedDate"
            (change)="onDateChange($any($event.target).value)"
            class="px-4 py-2.5 border-2 border-[#E1E1E1] rounded-xl focus:border-[#25509D] focus:outline-none font-bold shadow-lg bg-white"
          />
          <button
            (click)="loadData()"
            class="px-4 py-2.5 bg-gradient-to-r from-[#25509D] to-[#20264E] text-white rounded-xl font-bold hover:shadow-xl transition-all flex items-center gap-2"
          >
            <fa-icon [icon]="['fas', 'sync']"></fa-icon>
            <span class="hidden md:inline">Actualiser</span>
          </button>
        </div>
      </div>

      <!-- üìä STATS GLOBALES -->
      @if (dashboardData()) {
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="bg-white rounded-2xl p-4 shadow-lg border-2 border-[#99CFBD]/50">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-[#99CFBD]/20 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'dollar-sign']" class="text-[#99CFBD] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">TOTAL</p>
              <p class="text-xl font-black text-[#99CFBD]">
                {{ formatAmount(dashboardData()!.globalStats.totalAmount) }}
              </p>
              <p class="text-xs font-bold text-[#303131]">FCFA</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-lg border-2 border-[#25509D]/50">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-[#25509D]/20 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'receipt']" class="text-[#25509D] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">A PAYER AUX RESTAURANTS</p>
              <p class="text-xl font-black text-[#25509D]">
                {{
                  formatAmount(
                    dashboardData()!.globalStats.totalAmount +
                      dashboardData()!.globalStats.totalOrders * 1000
                  )
                }}
              </p>
              <p class="text-xs font-bold text-[#303131]">FCFA</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-lg border-2 border-[#E84141]/50">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-[#E84141]/20 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'gift']" class="text-[#E84141] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">SUBVENTION</p>
              <p class="text-xl font-black text-[#E84141]">
                {{ formatAmount(dashboardData()!.globalStats.totalOrders * 1000) }}
              </p>
              <p class="text-xs font-bold text-[#303131]">FCFA</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-lg border-2 border-[#20264E]/50">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-[#20264E]/20 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'shopping-cart']" class="text-[#20264E] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">COMMANDES DE LA JOURNEE</p>
              <p class="text-xl font-black text-[#20264E]">
                {{ dashboardData()!.globalStats.totalOrders }}
              </p>
              <p class="text-xs font-bold text-[#303131]">Total</p>
            </div>
          </div>
        </div>
      </div>
      }
    </div>

    @if (isLoading()) {
    <div class="flex justify-center items-center py-20">
      <div class="relative w-20 h-20">
        <div
          class="absolute inset-0 rounded-full border-4 border-[#25509D]/20 animate-ping opacity-20"
        ></div>
        <div
          class="absolute inset-0 rounded-full border-4 border-[#25509D] border-t-transparent animate-spin"
        ></div>
      </div>
    </div>
    } @if (!isLoading() && dashboardData()) {
    <!-- üè™ MINI CARDS RESTAURANTS -->
    <div class="mb-6">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
        <h2 class="text-2xl font-black text-[#20264E] flex items-center gap-2">
          <fa-icon [icon]="['fas', 'store']" class="text-[#E84141]"></fa-icon>
          Restaurants
        </h2>
        <button
          (click)="selectRestaurant(null)"
          [class]="
            filters().selectedRestaurantId === null
              ? 'px-4 py-2 bg-[#25509D] text-white rounded-xl font-bold shadow-lg'
              : 'px-4 py-2 bg-[#E1E1E1] text-[#303131] rounded-xl font-bold hover:bg-[#E1E1E1]/70'
          "
        >
          Tous les restaurants
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        @for (restaurant of filteredRestaurants(); track restaurant.restaurantId) {
        <div
          [class]="
            filters().selectedRestaurantId === restaurant.restaurantId
              ? 'bg-gradient-to-br from-[#25509D] to-[#20264E] text-white cursor-pointer'
              : 'bg-white hover:shadow-xl cursor-pointer'
          "
          class="rounded-2xl p-5 shadow-lg transition-all border-2 border-transparent hover:border-[#25509D]/30"
        >
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1 min-w-0" (click)="selectRestaurant(restaurant.restaurantId)">
              <h3
                [class]="
                  filters().selectedRestaurantId === restaurant.restaurantId
                    ? 'text-white'
                    : 'text-[#20264E]'
                "
                class="font-black text-lg truncate"
              >
                {{ restaurant.restaurantName }}
              </h3>
              <p
                [class]="
                  filters().selectedRestaurantId === restaurant.restaurantId
                    ? 'text-white/80'
                    : 'text-[#303131]'
                "
                class="text-sm font-medium"
              >
                {{ restaurant.totalOrders }} commande(s)
              </p>
            </div>
            <div class="flex gap-2 flex-shrink-0">
              <button
                (click)="openRestaurantStats(restaurant); $event.stopPropagation()"
                [class]="
                  filters().selectedRestaurantId === restaurant.restaurantId
                    ? 'bg-white/20 hover:bg-white/30'
                    : 'bg-[#25509D]/10 hover:bg-[#25509D]/20'
                "
                class="w-10 h-10 rounded-xl flex items-center justify-center transition-colors"
                title="Voir les statistiques"
              >
                <fa-icon
                  [icon]="['fas', 'chart-bar']"
                  [class]="
                    filters().selectedRestaurantId === restaurant.restaurantId
                      ? 'text-white'
                      : 'text-[#25509D]'
                  "
                ></fa-icon>
              </button>
              <button
                (click)="exportRestaurant(restaurant); $event.stopPropagation()"
                [class]="
                  filters().selectedRestaurantId === restaurant.restaurantId
                    ? 'bg-white/20 hover:bg-white/30'
                    : 'bg-[#99CFBD]/20 hover:bg-[#99CFBD]/30'
                "
                class="w-10 h-10 rounded-xl flex items-center justify-center transition-colors"
                title="Exporter en CSV"
              >
                <fa-icon
                  [icon]="['fas', 'download']"
                  [class]="
                    filters().selectedRestaurantId === restaurant.restaurantId
                      ? 'text-white'
                      : 'text-[#99CFBD]'
                  "
                ></fa-icon>
              </button>
            </div>
          </div>

          <div
            (click)="selectRestaurant(restaurant.restaurantId)"
            [class]="
              filters().selectedRestaurantId === restaurant.restaurantId
                ? 'bg-white/10'
                : 'bg-gradient-to-br from-[#99CFBD]/10 to-[#99CFBD]/20 border border-[#99CFBD]/30'
            "
            class="rounded-xl p-3"
          >
            <p
              [class]="
                filters().selectedRestaurantId === restaurant.restaurantId
                  ? 'text-white/70'
                  : 'text-[#303131]'
              "
              class="text-xs font-bold mb-1"
            >
              MONTANT TOTAL
            </p>
            <p
              [class]="
                filters().selectedRestaurantId === restaurant.restaurantId
                  ? 'text-white'
                  : 'text-[#99CFBD]'
              "
              class="text-2xl font-black"
            >
              {{ formatAmount(restaurant.totalAmount) }}
            </p>
            <p
              [class]="
                filters().selectedRestaurantId === restaurant.restaurantId
                  ? 'text-white/80'
                  : 'text-[#303131]'
              "
              class="text-xs font-bold"
            >
              FCFA
            </p>
          </div>

          <div
            class="grid grid-cols-2 gap-2 mt-3"
            (click)="selectRestaurant(restaurant.restaurantId)"
          >
            <div
              [class]="
                filters().selectedRestaurantId === restaurant.restaurantId
                  ? 'bg-white/10'
                  : 'bg-[#99CFBD]/10'
              "
              class="rounded-lg p-2 text-center"
            >
              <p
                [class]="
                  filters().selectedRestaurantId === restaurant.restaurantId
                    ? 'text-white/70'
                    : 'text-[#303131]'
                "
                class="text-xs font-semibold"
              >
                Confirm√©es
              </p>
              <p
                [class]="
                  filters().selectedRestaurantId === restaurant.restaurantId
                    ? 'text-white'
                    : 'text-[#99CFBD]'
                "
                class="text-xl font-black"
              >
                {{ restaurant.confirmedCount }}
              </p>
            </div>
            <div
              [class]="
                filters().selectedRestaurantId === restaurant.restaurantId
                  ? 'bg-white/10'
                  : 'bg-[#E84141]/10'
              "
              class="rounded-lg p-2 text-center"
            >
              <p
                [class]="
                  filters().selectedRestaurantId === restaurant.restaurantId
                    ? 'text-white/70'
                    : 'text-[#303131]'
                "
                class="text-xs font-semibold"
              >
                Annul√©es
              </p>
              <p
                [class]="
                  filters().selectedRestaurantId === restaurant.restaurantId
                    ? 'text-white'
                    : 'text-[#E84141]'
                "
                class="text-xl font-black"
              >
                {{ restaurant.cancelledCount }}
              </p>
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- üîç BARRE DE RECHERCHE -->
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6 border-2 border-[#E1E1E1]">
      <div class="flex flex-col md:flex-row gap-3">
        <div class="flex-1 relative">
          <fa-icon
            [icon]="['fas', 'search']"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-[#303131]/40"
          ></fa-icon>
          <input
            type="text"
            [value]="filters().searchTerm"
            (input)="onSearch($any($event.target).value)"
            placeholder="Rechercher par nom, plat ou restaurant..."
            class="w-full pl-12 pr-4 py-3 border-2 border-[#E1E1E1] rounded-xl focus:border-[#25509D] focus:outline-none font-medium"
          />
        </div>
        <label
          class="flex items-center gap-2 px-4 py-3 bg-[#E1E1E1]/30 rounded-xl cursor-pointer hover:bg-[#E1E1E1]/50 transition-colors"
        >
          <input
            type="checkbox"
            [checked]="filters().showCancelled"
            (change)="updateShowCancelled($event)"
            class="w-5 h-5 text-[#25509D] rounded accent-[#25509D]"
          />
          <span class="font-bold text-[#20264E]">Afficher annul√©es</span>
        </label>
      </div>
    </div>

    <!-- üë§ LISTE DES UTILISATEURS -->
    <div>
      <h2 class="text-2xl font-black text-[#20264E] mb-4 flex items-center gap-2">
        <fa-icon [icon]="['fas', 'users']" class="text-[#25509D]"></fa-icon>
        Commandes Utilisateurs ({{ filteredUsers().length }})
      </h2>

      <div class="space-y-4">
        @for (user of filteredUsers(); track user.userId) {
        <div
          class="bg-white rounded-2xl shadow-lg overflow-hidden border-2 border-[#E1E1E1] hover:border-[#25509D]/30 hover:shadow-xl transition-all"
        >
          <!-- Header utilisateur -->
          <div class="bg-gradient-to-r from-[#25509D] to-[#20264E] p-5">
            <div
              class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"
            >
              <div class="flex items-center gap-4">
                <div
                  class="w-14 h-14 bg-white/20 backdrop-blur rounded-2xl flex items-center justify-center text-white font-black text-2xl shadow-lg flex-shrink-0"
                >
                  {{ user.username.charAt(0).toUpperCase() }}
                </div>
                <div class="min-w-0">
                  <h3 class="text-xl sm:text-2xl font-black text-white truncate">
                    {{ user.username }}
                  </h3>
                  <p class="text-white/80 text-sm font-medium truncate">{{ user.email }}</p>
                  <div class="flex items-center gap-2 mt-1 flex-wrap">
                    <span
                      class="px-3 py-1 bg-white/20 rounded-lg text-xs font-bold text-white truncate"
                    >
                      {{ user.restaurants.join(', ') }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="text-left sm:text-right w-full sm:w-auto">
                <p class="text-sm text-white/80 font-bold mb-1">TOTAL √Ä PAYER</p>
                <p class="text-2xl sm:text-3xl font-black text-white">
                  {{ formatAmount(user.totalAmount) }}
                </p>
                <p class="text-sm text-white/90 font-bold">FCFA</p>
                @if (user.balance !== 0) {
                <p [class]="'text-xs font-bold mt-1 ' + getBalanceColor(user.balance)">
                  Dettes/Remboursements: {{ formatAmount(user.balance) }} F
                </p>
                }
              </div>
            </div>
          </div>

          <!-- Corps -->
          <div class="p-5">
            <!-- Plats command√©s -->
            <div class="mb-4">
              <h4 class="text-sm font-black text-[#20264E] mb-3 flex items-center gap-2">
                <fa-icon [icon]="['fas', 'utensils']" class="text-[#E84141]"></fa-icon>
                PLATS COMMAND√âS
              </h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                @for (meal of user.meals; track meal.name + meal.restaurant) {
                <div
                  class="bg-gradient-to-br from-[#E84141]/10 to-[#6B140F]/10 rounded-lg p-3 border border-[#E84141]/30"
                >
                  <div class="flex items-center justify-between gap-2">
                    <div class="flex-1 min-w-0">
                      <p class="font-bold text-[#20264E] text-sm truncate">{{ meal.name }}</p>
                      <p class="text-xs text-[#303131] truncate">{{ meal.restaurant }}</p>
                    </div>
                    <span class="text-2xl font-black text-[#E84141] flex-shrink-0"
                      >√ó{{ meal.quantity }}</span
                    >
                  </div>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
        }
      </div>

      @if (filteredUsers().length === 0) {
      <div class="text-center py-12 bg-white rounded-2xl shadow-lg border-2 border-[#E1E1E1]">
        <div class="text-6xl mb-4">üîç</div>
        <h3 class="text-2xl font-black text-[#20264E] mb-2">Aucun r√©sultat</h3>
        <p class="text-[#303131]">Essayez de modifier vos filtres</p>
      </div>
      }
    </div>
    }
  </div>
</div>

<!-- üìä MODAL STATISTIQUES RESTAURANT -->
@if (showStatsModal() && selectedRestaurantStats()) {
<div
  class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4"
  (click)="closeStatsModal()"
>
  <div
    class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden"
    (click)="$event.stopPropagation()"
  >
    <!-- Header Modal -->
    <div class="bg-gradient-to-r from-[#25509D] to-[#20264E] p-6 sticky top-0 z-10">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div
            class="w-16 h-16 bg-white/20 backdrop-blur rounded-2xl flex items-center justify-center"
          >
            <fa-icon [icon]="['fas', 'chart-bar']" class="text-white text-3xl"></fa-icon>
          </div>
          <div>
            <h2 class="text-2xl md:text-3xl font-black text-white">
              {{ selectedRestaurantStats()!.restaurant.restaurantName }}
            </h2>
            <p class="text-white/80 font-medium">Statistiques d√©taill√©es</p>
          </div>
        </div>
        <button
          (click)="closeStatsModal()"
          class="w-12 h-12 bg-white/20 hover:bg-white/30 rounded-xl cursor-pointer flex items-center justify-center transition-colors"
        >
          <fa-icon [icon]="['fas', 'times']" class="text-white text-xl"></fa-icon>
        </button>
      </div>
    </div>

    <!-- Corps Modal -->
    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
      <!-- Stats g√©n√©rales -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div
          class="bg-gradient-to-br from-[#99CFBD]/10 to-[#99CFBD]/20 rounded-2xl p-4 border border-[#99CFBD]/30"
        >
          <p class="text-xs font-bold text-[#303131] mb-1">COMMANDES TOTALES</p>
          <p class="text-3xl font-black text-[#99CFBD]">
            {{ selectedRestaurantStats()!.restaurant.totalOrders }}
          </p>
        </div>

        <div
          class="bg-gradient-to-br from-[#99CFBD]/10 to-[#99CFBD]/20 rounded-2xl p-4 border border-[#99CFBD]/30"
        >
          <p class="text-xs font-bold text-[#303131] mb-1">CONFIRM√âES</p>
          <p class="text-3xl font-black text-[#99CFBD]">
            {{ selectedRestaurantStats()!.restaurant.confirmedCount }}
          </p>
        </div>

        <div
          class="bg-gradient-to-br from-[#E84141]/10 to-[#6B140F]/10 rounded-2xl p-4 border border-[#E84141]/30"
        >
          <p class="text-xs font-bold text-[#303131] mb-1">ANNUL√âES</p>
          <p class="text-3xl font-black text-[#E84141]">
            {{ selectedRestaurantStats()!.restaurant.cancelledCount }}
          </p>
        </div>

        <div
          class="bg-gradient-to-br from-[#25509D]/10 to-[#20264E]/10 rounded-2xl p-4 border border-[#25509D]/30"
        >
          <p class="text-xs font-bold text-[#303131] mb-1">MONTANT TOTAL</p>
          <p class="text-2xl font-black text-[#25509D]">
            {{ formatAmount(selectedRestaurantStats()!.restaurant.totalAmount) }}
          </p>
          <p class="text-xs font-bold text-[#303131]">FCFA</p>
        </div>
      </div>

      <!-- Liste des plats -->
      <div>
        <h3 class="text-xl font-black text-[#20264E] mb-4 flex items-center gap-2">
          <fa-icon [icon]="['fas', 'utensils']" class="text-[#E84141]"></fa-icon>
          D√©tail des plats command√©s
        </h3>

        @if (selectedRestaurantStats()!.meals.length > 0) {
        <div class="space-y-3">
          @for (meal of selectedRestaurantStats()!.meals; track meal.mealName) {
          <div
            class="bg-gradient-to-r from-[#E1E1E1]/30 to-[#E1E1E1]/10 rounded-xl p-4 border border-[#E1E1E1] hover:border-[#25509D]/30 transition-all"
          >
            <div
              class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3"
            >
              <div class="flex items-center gap-4 flex-1 min-w-0">
                <div
                  class="w-14 h-14 bg-gradient-to-br from-[#E84141] to-[#6B140F] rounded-xl flex items-center justify-center flex-shrink-0"
                >
                  <fa-icon [icon]="['fas', 'utensils']" class="text-white text-xl"></fa-icon>
                </div>
                <div class="min-w-0 flex-1">
                  <h4 class="font-black text-lg text-[#20264E] truncate">{{ meal.mealName }}</h4>
                  <div class="flex items-center gap-4 mt-1 flex-wrap">
                    <span class="text-sm font-bold text-[#303131]">
                      <fa-icon
                        [icon]="['fas', 'shopping-cart']"
                        class="text-[#99CFBD] mr-1"
                      ></fa-icon>
                      {{ meal.quantity }} command√©(s)
                    </span>
                    <span class="text-sm font-bold text-[#99CFBD]">
                      {{ formatAmount(meal.totalAmount) }} FCFA
                    </span>
                  </div>
                </div>
              </div>
              <div class="bg-[#E84141]/10 rounded-lg px-4 py-2 flex-shrink-0">
                <p class="text-3xl font-black text-[#E84141]">√ó{{ meal.quantity }}</p>
              </div>
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="text-center py-12 bg-[#E1E1E1]/20 rounded-2xl">
          <div class="text-5xl mb-3">üçΩÔ∏è</div>
          <p class="text-[#303131] font-medium">Aucun plat command√© pour ce restaurant</p>
        </div>
        }
      </div>
    </div>

    <!-- Footer Modal -->
    <div class="bg-[#E1E1E1]/30 p-4 sticky bottom-0">
      <div class="flex justify-end gap-3">
        <button
          (click)="exportRestaurant(selectedRestaurantStats()!.restaurant)"
          class="px-6 cursor-pointer py-3 bg-gradient-to-r from-[#99CFBD] to-[#99CFBD]/80 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center gap-2"
        >
          <fa-icon [icon]="['fas', 'download']"></fa-icon>
          Exporter CSV
        </button>
        <button
          (click)="closeStatsModal()"
          class="px-6 cursor-pointer py-3 bg-gradient-to-r from-[#25509D] to-[#20264E] text-white rounded-xl font-bold hover:shadow-lg transition-all"
        >
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>
}

<!-- üí∞ MODAL PAIEMENT ET VALIDATION -->
@if (showPaymentModal()) {
<div
  class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4"
  (click)="closePaymentModal()"
>
  <div
    class="bg-white rounded-3xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden"
    (click)="$event.stopPropagation()"
  >
    <!-- Header Modal -->
    <div class="bg-gradient-to-r from-[#25509D] to-[#20264E] p-6 sticky top-0 z-10">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div
            class="w-16 h-16 bg-white/20 backdrop-blur rounded-2xl flex items-center justify-center"
          >
            <fa-icon [icon]="['fas', 'money-bill-wave']" class="text-white text-3xl"></fa-icon>
          </div>
          <div>
            <h2 class="text-2xl md:text-3xl font-black text-white">
              Validation & Paiement Restaurants
            </h2>
            <p class="text-white/80 font-medium">R√©capitulatif et validation des paiements</p>
          </div>
        </div>
        <button
          (click)="closePaymentModal()"
          class="w-12 h-12 bg-white/20 hover:bg-white/30 rounded-xl cursor-pointer flex items-center justify-center transition-colors"
        >
          <fa-icon [icon]="['fas', 'times']" class="text-white text-xl"></fa-icon>
        </button>
      </div>
    </div>

    <!-- Corps Modal -->
    <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
      @if (isLoadingPayment()) {
      <!-- Chargement -->
      <div class="flex flex-col items-center justify-center py-20">
        <div class="relative w-24 h-24 mb-6">
          <div
            class="absolute inset-0 rounded-full border-4 border-[#25509D]/20 animate-ping opacity-20"
          ></div>
          <div
            class="absolute inset-0 rounded-full border-4 border-[#25509D] border-t-transparent animate-spin"
          ></div>
        </div>
        <p class="text-xl font-bold text-[#20264E]">Chargement du r√©capitulatif...</p>
      </div>
      } @else if (paymentSummary()) {
      <!-- P√©riode de paiement -->
      <div
        class="bg-gradient-to-br from-[#99CFBD]/10 to-[#99CFBD]/20 rounded-2xl p-6 mb-6 border-2 border-[#99CFBD]/30"
      >
        <div class="flex items-center gap-3 mb-4">
          <fa-icon [icon]="['fas', 'calendar-alt']" class="text-[#99CFBD] text-2xl"></fa-icon>
          <h3 class="text-xl font-black text-[#20264E]">P√©riode de paiement</h3>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white rounded-xl p-4">
            <p class="text-xs font-bold text-[#303131] mb-2">D√âBUT</p>
            <p class="text-lg font-black text-[#25509D]">
              {{ formatDate(paymentSummary()!.startDate) }}
            </p>
          </div>
          <div class="bg-white rounded-xl p-4">
            <p class="text-xs font-bold text-[#303131] mb-2">FIN</p>
            <p class="text-lg font-black text-[#25509D]">
              {{ formatDate(paymentSummary()!.endDate) }}
            </p>
          </div>
          <div class="bg-white rounded-xl p-4">
            <p class="text-xs font-bold text-[#303131] mb-2">DERNIER PAIEMENT</p>
            <p class="text-lg font-black text-[#E84141]">
              {{
                paymentSummary()!.lastPaymentDate
                  ? formatDate(paymentSummary()!.lastPaymentDate!)
                  : 'Aucun'
              }}
            </p>
          </div>
        </div>
      </div>

      <!-- Statistiques globales -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div
          class="bg-gradient-to-br from-[#99CFBD]/10 to-[#99CFBD]/20 rounded-2xl p-5 border-2 border-[#99CFBD]/30"
        >
          <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 bg-[#99CFBD]/30 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'dollar-sign']" class="text-[#99CFBD] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">TOTAL AVEC SUBVENTION</p>
            </div>
          </div>
          <p class="text-3xl font-black text-[#99CFBD]">
            {{ formatAmount(paymentSummary()!.globalStats.totalAmountWithSubsidy) }}
          </p>
          <p class="text-sm font-bold text-[#303131]">FCFA</p>
        </div>

        <div
          class="bg-gradient-to-br from-[#25509D]/10 to-[#20264E]/10 rounded-2xl p-5 border-2 border-[#25509D]/30"
        >
          <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 bg-[#25509D]/30 rounded-xl flex items-center justify-center">
              <fa-icon
                [icon]="['fas', 'hand-holding-usd']"
                class="text-[#25509D] text-xl"
              ></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">MONTANT √Ä PAYER RESTAURANTS</p>
            </div>
          </div>
          <p class="text-3xl font-black text-[#25509D]">
            {{ formatAmount(paymentSummary()!.globalStats.totalAmountWithoutSubsidy) }}
          </p>
          <p class="text-sm font-bold text-[#303131]">FCFA</p>
        </div>

        <div
          class="bg-gradient-to-br from-[#E84141]/10 to-[#6B140F]/10 rounded-2xl p-5 border-2 border-[#E84141]/30"
        >
          <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 bg-[#E84141]/30 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'gift']" class="text-[#E84141] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">SUBVENTION TOTALE</p>
            </div>
          </div>
          <p class="text-3xl font-black text-[#E84141]">
            {{ formatAmount(paymentSummary()!.globalStats.totalSubsidy) }}
          </p>
          <p class="text-sm font-bold text-[#303131]">FCFA</p>
        </div>

        <div
          class="bg-gradient-to-br from-[#20264E]/10 to-[#20264E]/20 rounded-2xl p-5 border-2 border-[#20264E]/30"
        >
          <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 bg-[#20264E]/30 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'truck']" class="text-[#20264E] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">FRAIS DE LIVRAISON</p>
            </div>
          </div>
          <p class="text-3xl font-black text-[#20264E]">
            {{ formatAmount(paymentSummary()!.globalStats.totalDeliveryFees) }}
          </p>
          <p class="text-sm font-bold text-[#303131]">FCFA</p>
        </div>

        <div
          class="bg-gradient-to-br from-[#99CFBD]/10 to-[#99CFBD]/20 rounded-2xl p-5 border-2 border-[#99CFBD]/30"
        >
          <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 bg-[#99CFBD]/30 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'shopping-cart']" class="text-[#99CFBD] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">COMMANDES TOTALES</p>
            </div>
          </div>
          <p class="text-3xl font-black text-[#99CFBD]">
            {{ paymentSummary()!.globalStats.totalOrders }}
          </p>
          <p class="text-sm font-bold text-[#303131]">Commandes</p>
        </div>

        <div
          class="bg-gradient-to-br from-[#25509D]/10 to-[#25509D]/20 rounded-2xl p-5 border-2 border-[#25509D]/30"
        >
          <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 bg-[#25509D]/30 rounded-xl flex items-center justify-center">
              <fa-icon [icon]="['fas', 'users']" class="text-[#25509D] text-xl"></fa-icon>
            </div>
            <div>
              <p class="text-xs font-bold text-[#303131]">UTILISATEURS</p>
            </div>
          </div>
          <p class="text-3xl font-black text-[#25509D]">
            {{ paymentSummary()!.globalStats.totalUsers }}
          </p>
          <p class="text-sm font-bold text-[#303131]">Utilisateurs</p>
        </div>
      </div>
      }
    </div>

    <!-- Footer Modal -->
    <div
      class="bg-gradient-to-r from-[#E1E1E1]/50 to-[#E1E1E1]/30 p-6 sticky bottom-0 border-t-2 border-[#E1E1E1]"
    >
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-[#E84141]/20 rounded-xl flex items-center justify-center">
            <fa-icon
              [icon]="['fas', 'exclamation-triangle']"
              class="text-[#E84141] text-xl"
            ></fa-icon>
          </div>
          <p class="text-sm font-bold text-[#303131]">
            Cette action est <span class="text-[#E84141]">irr√©versible</span>. V√©rifiez bien toutes
            les informations.
          </p>
        </div>

        <div class="flex gap-3 w-full sm:w-auto">
          <button
            (click)="closePaymentModal()"
            class="flex-1 sm:flex-none px-6 py-3 bg-[#E1E1E1] hover:bg-[#E1E1E1]/70 text-[#303131] rounded-xl font-bold transition-all cursor-pointer"
          >
            Annuler
          </button>
          <button
            (click)="validatePayment()"
            [disabled]="
              isLoadingPayment() || !paymentSummary() || !paymentSummary()!.restaurants.length
            "
            [class.opacity-50]="
              isLoadingPayment() || !(paymentSummary() && paymentSummary()!.restaurants.length)
            "
            [class.cursor-not-allowed]="
              isLoadingPayment() || !(paymentSummary() && paymentSummary()!.restaurants.length)
            "
            class="flex-1 sm:flex-none px-6 py-3 bg-gradient-to-r from-[#99CFBD] to-[#99CFBD]/80 hover:from-[#99CFBD]/90 hover:to-[#99CFBD]/70 text-white rounded-xl font-bold hover:shadow-xl transition-all flex items-center justify-center gap-2 cursor-pointer"
          >
            <fa-icon [icon]="['fas', 'check-circle']"></fa-icon>
            <span>{{ isLoadingPayment() ? 'Validation...' : 'Valider' }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
}
